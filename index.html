<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Random Restaurant Picker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg-gradient: radial-gradient(circle at top left, #4f46e5 0, #0f172a 45%, #020617 100%);
      --card-bg: #0b1220;
      --card-border: rgba(148, 163, 184, 0.4);
      --card-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
      --accent: #6366f1;
      --accent-soft: rgba(99, 102, 241, 0.15);
      --accent-strong: #4f46e5;
      --accent-hover: #818cf8;
      --danger: #ef4444;
      --danger-soft: rgba(239, 68, 68, 0.15);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --chip-bg: rgba(148, 163, 184, 0.2);
      --chip-border: rgba(148, 163, 184, 0.5);
      --input-bg: rgba(15, 23, 42, 0.85);
      --input-border: rgba(148, 163, 184, 0.4);
      --input-border-focus: #6366f1;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --transition-fast: 0.15s ease-out;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: var(--bg-gradient);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 1rem;
    }

    .app-shell {
      width: 100%;
      max-width: 960px;
      margin: auto;
    }

    header {
      text-align: center;
      margin-bottom: 1rem;
    }

    header h1 {
      font-size: 1.8rem;
      letter-spacing: 0.03em;
      margin: 0;
      background: linear-gradient(to right, #e5e7eb, #a5b4fc);
      -webkit-background-clip: text;
      color: transparent;
    }

    header p {
      margin: 0.4rem 0 0;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .section {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      border: 1px solid var(--card-border);
      box-shadow: var(--card-shadow);
      padding: 0.9rem 0.9rem 1rem;
      margin-bottom: 1rem;
      backdrop-filter: blur(16px);
    }

    .section h2 {
      font-size: 1rem;
      margin: 0 0 0.6rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      color: #e5e7eb;
    }

    .section h2 span.emoji {
      font-size: 1.1rem;
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-top: 0.5rem;
      color: var(--text-main);
    }

    label .small {
      display: block;
      margin-top: 0.15rem;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"] {
      width: 100%;
      margin-top: 0.25rem;
      padding: 0.5rem 0.6rem;
      font-size: 0.9rem;
      border-radius: 999px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-main);
      outline: none;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast),
        background-color var(--transition-fast), transform var(--transition-fast);
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus {
      border-color: var(--input-border-focus);
      box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.6);
      transform: translateY(-1px);
      background: #020617;
    }

    button {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 0.35rem;
      width: 100%;
      box-sizing: border-box;
      margin-top: 0.4rem;
      padding: 0.5rem 0.8rem;
      font-size: 0.9rem;
      border-radius: 999px;
      border: none;
      font-weight: 500;
      color: white;
      background: linear-gradient(to right, var(--accent), var(--accent-strong));
      cursor: pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast),
        background var(--transition-fast), opacity var(--transition-fast);
      box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      background: linear-gradient(to right, var(--accent-hover), var(--accent));
      box-shadow: 0 16px 35px rgba(79, 70, 229, 0.65);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 6px 18px rgba(79, 70, 229, 0.55);
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    .btn-secondary {
      background: radial-gradient(circle at top, rgba(148, 163, 184, 0.15), #020617);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--text-main);
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.8);
    }

    .btn-secondary:hover:not(:disabled) {
      background: radial-gradient(circle at top, rgba(148, 163, 184, 0.25), #020617);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.95);
    }

    .btn-danger {
      background: linear-gradient(to right, #f97373, var(--danger));
      box-shadow: 0 10px 25px rgba(248, 113, 113, 0.4);
    }

    .small {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      background: var(--chip-bg);
      border-radius: 999px;
      padding: 0.08rem 0.5rem;
      margin: 0.05rem;
      font-size: 0.75rem;
      border: 1px solid var(--chip-border);
      color: #e5e7eb;
    }

    .restaurant-item {
      padding: 0.4rem 0;
      border-bottom: 1px dashed rgba(55, 65, 81, 0.6);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.6rem;
      font-size: 0.9rem;
    }

    .restaurant-item:last-child {
      border-bottom: none;
    }

    .restaurant-name {
      font-weight: 600;
      color: #e5e7eb;
    }

    .btn-row {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      align-items: flex-end;
    }

    .small-btn {
      width: auto;
      padding: 0.25rem 0.55rem;
      font-size: 0.75rem;
    }

    #result {
      font-weight: 700;
      font-size: 1.1rem;
      text-align: center;
      margin-top: 0.7rem;
      padding: 0.5rem 0.7rem;
      border-radius: 999px;
      background: var(--accent-soft);
      color: #e5e7eb;
    }

    #currentGroupDisplay {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
    }

    .auth-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }

    .auth-row button {
      width: auto;
    }

    #authStatus {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    #tagOptions, #peopleOptions, #filterTagOptions, #filterPeopleOptions {
      margin-top: 0.35rem;
      padding: 0.45rem 0.5rem;
      border-radius: 12px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), #020617);
      border: 1px solid rgba(51, 65, 85, 0.8);
    }

    .tag-option, .person-option {
      display: inline-flex;
      align-items: center;
      margin: 0.1rem 0.45rem 0.1rem 0;
      font-size: 0.8rem;
      color: #e5e7eb;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      cursor: pointer;
      transition: background-color var(--transition-fast), border-color var(--transition-fast),
        transform var(--transition-fast);
      border: 1px solid transparent;
    }

    .tag-option input,
    .person-option input {
      width: auto;
      margin-right: 0.3rem;
      margin-top: 0;
      accent-color: var(--accent);
    }

    .tag-option:hover,
    .person-option:hover {
      background-color: rgba(148, 163, 184, 0.18);
      border-color: rgba(148, 163, 184, 0.6);
      transform: translateY(-0.5px);
    }

    .import-row {
      border-bottom: 1px dashed rgba(55, 65, 81, 0.7);
      padding: 0.5rem 0;
      font-size: 0.8rem;
    }

    .import-row:last-child {
      border-bottom: none;
    }

    .import-header {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: #e5e7eb;
    }

    .pill-heading {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.15rem 0.65rem;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.1);
      border: 1px solid rgba(129, 140, 248, 0.7);
      font-size: 0.75rem;
      color: #c7d2fe;
      margin-left: auto;
    }

    .section-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    @media (min-width: 800px) {
      .grid-2 {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
        gap: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <h1>Random Restaurant Picker</h1>
      <p>Shareable groups, tags, people filters, and just enough chaos.</p>
    </header>

    <!-- Auth section -->
    <div class="section">
      <div class="section-header-row">
        <h2><span class="emoji">üîê</span> Sign In</h2>
        <div class="pill-heading">Firebase + Google Auth</div>
      </div>
      <div class="auth-row">
        <button id="signInBtn" class="btn-secondary">Sign in with Google</button>
        <button id="signOutBtn" class="btn-secondary" disabled>Sign out</button>
        <span id="authStatus">Not signed in. You can view lists but must sign in to create and edit your own groups.</span>
      </div>
    </div>

    <!-- Group / List selection -->
    <div class="section">
      <div class="section-header-row">
        <h2><span class="emoji">üìÇ</span> Group / List</h2>
        <div class="pill-heading">Each group is its own shared universe</div>
      </div>
      <form id="groupForm">
        <label>
          Group ID (e.g. My Stuff)
          <span class="small">
            Everyone using the same Group ID shares the same list.
            The first signed-in person to use a new ID becomes its owner.
          </span>
          <input type="text" id="groupInput" placeholder="my-stuff" required>
        </label>
        <button type="submit" style="margin-top:0.6rem;">Use this Group</button>
      </form>
      <div id="currentGroupDisplay"></div>
    </div>

    <div class="grid-2">
      <!-- Add / edit restaurant -->
      <div class="section">
        <div class="section-header-row">
          <h2><span class="emoji">üçΩÔ∏è</span> Add / Update Restaurant</h2>
        </div>
        <p class="small" id="editHint"></p>
        <form id="addForm">
          <label>
            Restaurant name:
            <input type="text" id="nameInput" required>
          </label>

          <label>
            Tags (comma separated)
            <span class="small">Example: Italian, cheap, date night</span>
            <input type="text" id="tagsInput" placeholder="Italian, cheap, date night">
          </label>

          <div id="tagOptions" class="small">
            <!-- tag checkboxes will be rendered here -->
          </div>

          <label>
            People who are ok with this (comma separated)
            <span class="small">Example: John, Bob, Roommate</span>
            <input type="text" id="peopleInput" placeholder="John, Bob, Roommate">
          </label>

          <div id="peopleOptions" class="small">
            <!-- people checkboxes will be rendered here -->
          </div>

          <button type="submit" style="margin-top:0.6rem;">Save Restaurant</button>
        </form>
      </div>

      <!-- Filters + random pick -->
      <div class="section">
        <div class="section-header-row">
          <h2><span class="emoji">üé≤</span> Pick One</h2>
        </div>

        <label>
          People present (comma separated)
          <span class="small">Only show places everyone here is ok with</span>
          <input type="text" id="filterPeopleInput" placeholder="John, Bob, Roommate">
        </label>

        <div id="filterPeopleOptions" class="small">
          <!-- filter people checkboxes -->
        </div>

        <label>
          Required tags (comma separated)
          <span class="small">Example: Italian, takeout</span>
          <input type="text" id="filterTagsInput" placeholder="Italian">
        </label>

        <div id="filterTagOptions" class="small">
          <!-- filter tag checkboxes -->
        </div>

        <button id="pickBtn" style="margin-top:0.6rem;">üé≤ Pick Random Restaurant</button>
        <div id="result"></div>
      </div>
    </div>

    <!-- Import from another group -->
    <div class="section">
      <div class="section-header-row">
        <h2><span class="emoji">üì•</span> Import from Another Group</h2>
        <div class="pill-heading">Copy, don‚Äôt mutate</div>
      </div>
      <p class="small">
        Want to borrow someone else's list without giving them write access? Enter their group ID,
        load their restaurants, tweak tags/people, and import into your current group.
      </p>
      <form id="importForm">
        <label>
          Source Group ID (read-only)
          <span class="small">Example: your-friend-group. You can see it if they tell you.</span>
          <input type="text" id="importGroupInput" placeholder="friend-group-id" required>
        </label>
        <button type="submit" class="btn-secondary" style="margin-top:0.6rem;">Load Restaurants from Source Group</button>
      </form>
      <div id="importList" style="margin-top:0.5rem;"></div>
      <button id="importSelectedBtn" class="btn-secondary" style="margin-top:0.6rem;" disabled>
        Import Selected into My Current Group
      </button>
      <p class="small">
        Importing makes copies into <strong>your</strong> group only. The source group is never changed.
      </p>
    </div>

    <!-- List of restaurants -->
    <div class="section">
      <div class="section-header-row">
        <h2><span class="emoji">üìã</span> Saved Restaurants for This Group</h2>
      </div>
      <div id="list"></div>
      <p class="small">
        Data is stored in Firebase Firestore, per Group ID.
        Anyone can view any group if they know its name. Only the group owner can edit that group.
      </p>
    </div>
  </div>

  <!-- Firebase + app logic -->
  <script type="module">
    // ---- Firebase imports (CDN modular SDK) ----
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js';
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      getDocs,
      deleteDoc,
      getDoc
    } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';

    // Your existing Firebase config (unchanged)
    const firebaseConfig = {
      apiKey: "AIzaSyC2xQS-opDsHikzS2DQyCZ7MNIlquENrPY",
      authDomain: "restaurant-picker-82bfa.firebaseapp.com",
      projectId: "restaurant-picker-82bfa",
      storageBucket: "restaurant-picker-82bfa.firebasestorage.app",
      messagingSenderId: "1000330063502",
      appId: "1:1000330063502:web:a307f6354e0fee2960a3df"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let currentGroupId = null;
    let currentGroupOwnerUid = null;
    let currentGroupOwnerName = null;
    let restaurants = [];
    let groupTags = [];
    let groupPeople = [];
    let currentUser = null;

    // Import state
    let importGroupId = null;
    let importRestaurants = [];

    const authStatusEl = document.getElementById('authStatus');
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const editHintEl = document.getElementById('editHint');

    const nameInput = document.getElementById('nameInput');
    const tagsInput = document.getElementById('tagsInput');
    const peopleInput = document.getElementById('peopleInput');

    const importSelectedBtn = document.getElementById('importSelectedBtn');

    function normalizeList(str) {
      if (!str) return [];
      return str
        .split(',')
        .map(s => s.trim())
        .filter(Boolean)
        .map(s => s.toLowerCase());
    }

    function hasWriteAccess() {
      return (
        currentUser &&
        currentGroupOwnerUid &&
        currentUser.uid === currentGroupOwnerUid
      );
    }

    function setCurrentGroupDisplay(extraMessage = '') {
      const div = document.getElementById('currentGroupDisplay');

      if (!currentGroupId) {
        div.textContent = 'No group selected yet.';
        return;
      }

      let text = `Current group: ${currentGroupId}`;
      if (currentGroupOwnerUid) {
        if (currentUser && currentUser.uid === currentGroupOwnerUid) {
          text += ' (You own this group)';
        } else if (currentGroupOwnerName) {
          text += ` (Owner: ${currentGroupOwnerName})`;
        } else {
          text += ' (Owner unknown)';
        }
      } else {
        text += ' (This group does not exist yet.)';
      }

      if (extraMessage) {
        text += ' ‚Äî ' + extraMessage;
      }

      div.textContent = text;
    }

    function updateEditHint() {
      if (!currentGroupId) {
        editHintEl.textContent = 'Select or create a group to view and edit restaurants.';
        return;
      }

      if (!currentGroupOwnerUid) {
        if (!currentUser) {
          editHintEl.textContent = 'This group does not exist yet. Sign in and press "Use this Group" again to create it and become the owner.';
        } else {
          editHintEl.textContent = 'Creating this group for you as owner...';
        }
        return;
      }

      if (hasWriteAccess()) {
        editHintEl.textContent = 'You own this group. You can add, edit, and delete restaurants. Use ‚úèÔ∏è Edit to modify an existing one.';
      } else {
        editHintEl.textContent = 'This group is read-only for you. You can view and pick, but only the owner can edit.';
      }
    }

    function recomputeGroupTagsAndPeople() {
      const tagSet = new Set();
      const peopleSet = new Set();

      restaurants.forEach(r => {
        (r.tags || []).forEach(t => {
          if (t) tagSet.add(t);
        });
        (r.people || []).forEach(p => {
          if (p) peopleSet.add(p);
        });
      });

      groupTags = Array.from(tagSet).sort();
      groupPeople = Array.from(peopleSet).sort();
    }

    function setTagCheckboxesForTags(tags) {
      const lowerSet = new Set((tags || []).map(t => t.toLowerCase()));
      document
        .querySelectorAll('#tagOptions input[type="checkbox"]')
        .forEach(cb => {
          cb.checked = lowerSet.has(cb.value.toLowerCase());
        });
    }

    function setPeopleCheckboxesForPeople(people) {
      const lowerSet = new Set((people || []).map(p => p.toLowerCase()));
      document
        .querySelectorAll('#peopleOptions input[type="checkbox"]')
        .forEach(cb => {
          cb.checked = lowerSet.has(cb.value.toLowerCase());
        });
    }

    function renderTagOptions() {
      const container = document.getElementById('tagOptions');
      container.innerHTML = '';

      if (!currentGroupId) {
        container.textContent = 'Select a group to see its tags.';
        return;
      }

      if (groupTags.length === 0) {
        container.textContent = 'No tags in this group yet. Type new tags above to start building a list.';
        return;
      }

      const info = document.createElement('div');
      info.textContent = 'Existing tags in this group (tap to add to this restaurant):';
      container.appendChild(info);

      groupTags.forEach(tag => {
        const label = document.createElement('label');
        label.className = 'tag-option';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = tag;

        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(tag));
        container.appendChild(label);
      });
    }

    function renderPeopleOptions() {
      const container = document.getElementById('peopleOptions');
      container.innerHTML = '';

      if (!currentGroupId) {
        container.textContent = 'Select a group to see people.';
        return;
      }

      if (groupPeople.length === 0) {
        container.textContent = 'No people saved yet. Type some names above to start building a list.';
        return;
      }

      const info = document.createElement('div');
      info.textContent = 'People you‚Äôve used in this group (tap to add to this restaurant):';
      container.appendChild(info);

      groupPeople.forEach(person => {
        const label = document.createElement('label');
        label.className = 'person-option';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = person;

        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(person));
        container.appendChild(label);
      });
    }

    function renderFilterTagOptions() {
      const container = document.getElementById('filterTagOptions');
      container.innerHTML = '';

      if (!currentGroupId) {
        container.textContent = 'Select a group to see its tags.';
        return;
      }

      if (groupTags.length === 0) {
        container.textContent = 'No tags in this group yet.';
        return;
      }

      const info = document.createElement('div');
      info.textContent = 'Tap tags to require them when picking:';
      container.appendChild(info);

      groupTags.forEach(tag => {
        const label = document.createElement('label');
        label.className = 'tag-option';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = tag;

        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(tag));
        container.appendChild(label);
      });
    }

    function renderFilterPeopleOptions() {
      const container = document.getElementById('filterPeopleOptions');
      container.innerHTML = '';

      if (!currentGroupId) {
        container.textContent = 'Select a group to see people.';
        return;
      }

      if (groupPeople.length === 0) {
        container.textContent = 'No people saved yet.';
        return;
      }

      const info = document.createElement('div');
      info.textContent = 'Tap who is present:';
      container.appendChild(info);

      groupPeople.forEach(person => {
        const label = document.createElement('label');
        label.className = 'person-option';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = person;

        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(person));
        container.appendChild(label);
      });
    }

    function renderList() {
      const listDiv = document.getElementById('list');
      listDiv.innerHTML = '';

      if (!currentGroupId) {
        listDiv.textContent = 'Select a Group ID above to see its restaurants.';
        return;
      }

      if (restaurants.length === 0) {
        listDiv.textContent = 'No restaurants saved yet for this group.';
        return;
      }

      restaurants.forEach((r) => {
        const item = document.createElement('div');
        item.className = 'restaurant-item';

        const left = document.createElement('div');

        const nameEl = document.createElement('div');
        nameEl.className = 'restaurant-name';
        nameEl.textContent = r.name;
        left.appendChild(nameEl);

        const tagsLine = document.createElement('div');
        r.tags.forEach(t => {
          const span = document.createElement('span');
          span.className = 'badge';
          span.textContent = t;
          tagsLine.appendChild(span);
        });
        left.appendChild(tagsLine);

        const peopleLine = document.createElement('div');
        peopleLine.className = 'small';
        peopleLine.textContent = 'OK for: ' + (r.people.join(', ') || 'Anyone');
        left.appendChild(peopleLine);

        item.appendChild(left);

        const btnCol = document.createElement('div');
        btnCol.className = 'btn-row';

        const editBtn = document.createElement('button');
        editBtn.textContent = '‚úèÔ∏è Edit';
        editBtn.className = 'small-btn btn-secondary';
        editBtn.disabled = !hasWriteAccess();
        editBtn.title = hasWriteAccess()
          ? 'Edit this restaurant'
          : 'Only the group owner can edit restaurants';

        editBtn.addEventListener('click', () => {
          if (!hasWriteAccess()) {
            alert('You do not own this group, so you cannot edit restaurants.');
            return;
          }
          nameInput.value = r.name;
          tagsInput.value = (r.tags || []).join(', ');
          peopleInput.value = (r.people || []).join(', ');
          setTagCheckboxesForTags(r.tags);
          setPeopleCheckboxesForPeople(r.people);
          document.getElementById('addForm').scrollIntoView({ behavior: 'smooth' });
        });

        btnCol.appendChild(editBtn);

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.className = 'small-btn btn-danger';
        delBtn.disabled = !hasWriteAccess();
        delBtn.title = hasWriteAccess()
          ? 'Delete this restaurant'
          : 'Only the group owner can delete restaurants';

        delBtn.addEventListener('click', async () => {
          if (!hasWriteAccess()) {
            alert('You do not own this group, so you cannot delete restaurants.');
            return;
          }
          await deleteRestaurant(r.id);
        });

        btnCol.appendChild(delBtn);

        item.appendChild(btnCol);

        listDiv.appendChild(item);
      });
    }

    function groupDocRef() {
      if (!currentGroupId) return null;
      return doc(db, 'groups', currentGroupId);
    }

    function groupRestaurantsCollection() {
      if (!currentGroupId) return null;
      return collection(db, 'groups', currentGroupId, 'restaurants');
    }

    // --- Import helpers ---

    async function loadImportGroupRestaurants(sourceGroupRaw) {
      const normalized = sourceGroupRaw
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');
      if (!normalized) {
        importGroupId = null;
        importRestaurants = [];
        renderImportList();
        return;
      }

      importGroupId = normalized;
      importRestaurants = [];

      try {
        const colRef = collection(db, 'groups', importGroupId, 'restaurants');
        const snap = await getDocs(colRef);
        importRestaurants = snap.docs.map(docSnap => {
          const data = docSnap.data();
          return {
            id: docSnap.id,
            name: data.name || '',
            tags: data.tags || [],
            people: data.people || []
          };
        });
      } catch (err) {
        console.error('Error loading import group:', err);
        importRestaurants = [];
      }

      renderImportList();
    }

    function renderImportList() {
      const listDiv = document.getElementById('importList');
      listDiv.innerHTML = '';

      if (!importGroupId) {
        listDiv.textContent = 'Enter a source group ID above and load its restaurants.';
        importSelectedBtn.disabled = true;
        return;
      }

      if (importRestaurants.length === 0) {
        listDiv.textContent = 'No restaurants found in that source group (or it does not exist).';
        importSelectedBtn.disabled = true;
        return;
      }

      importSelectedBtn.disabled = false;

      const header = document.createElement('div');
      header.className = 'import-header';
      header.textContent = `Restaurants in source group: ${importGroupId}`;
      listDiv.appendChild(header);

      importRestaurants.forEach((r, index) => {
        const row = document.createElement('div');
        row.className = 'import-row';
        row.dataset.index = index;

        const topLine = document.createElement('div');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = true;
        cb.dataset.index = index;
        cb.style.marginRight = '0.4rem';
        topLine.appendChild(cb);

        const nameSpan = document.createElement('span');
        nameSpan.style.fontWeight = '600';
        nameSpan.textContent = r.name || '(unnamed)';
        topLine.appendChild(nameSpan);

        row.appendChild(topLine);

        const tagsLabel = document.createElement('label');
        tagsLabel.textContent = 'Tags (edit before importing):';
        const tagsInput = document.createElement('input');
        tagsInput.type = 'text';
        tagsInput.value = (r.tags || []).join(', ');
        tagsInput.className = 'import-tags-input';
        tagsInput.dataset.index = index;
        tagsLabel.appendChild(tagsInput);
        row.appendChild(tagsLabel);

        const peopleLabel = document.createElement('label');
        peopleLabel.textContent = 'People OK with this (edit before importing):';
        const peopleInput = document.createElement('input');
        peopleInput.type = 'text';
        peopleInput.value = (r.people || []).join(', ');
        peopleInput.className = 'import-people-input';
        peopleInput.dataset.index = index;
        peopleLabel.appendChild(peopleInput);
        row.appendChild(peopleLabel);

        listDiv.appendChild(row);
      });
    }

    async function importSelectedRestaurants() {
      if (!currentGroupId) {
        alert('Select your own Group ID first (the destination).');
        return;
      }
      if (!hasWriteAccess()) {
        alert('You must own the current group to import into it.');
        return;
      }
      if (!importGroupId || importRestaurants.length === 0) {
        alert('Load a source group with restaurants first.');
        return;
      }

      const colRef = groupRestaurantsCollection();
      if (!colRef) {
        alert('Destination group not available.');
        return;
      }

      const rows = document.querySelectorAll('#importList .import-row');
      const writePromises = [];

      rows.forEach(row => {
        const index = parseInt(row.dataset.index, 10);
        if (Number.isNaN(index)) return;

        const cb = row.querySelector('input[type="checkbox"]');
        if (!cb || !cb.checked) return;

        const base = importRestaurants[index];
        if (!base || !base.name) return;

        const tagsInputEl = row.querySelector('.import-tags-input');
        const peopleInputEl = row.querySelector('.import-people-input');

        const name = base.name.trim();
        if (!name) return;

        const tags = normalizeList(tagsInputEl ? tagsInputEl.value : '');
        const people = normalizeList(peopleInputEl ? peopleInputEl.value : '');

        const docId = name.toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-|-$/g, '') || 'restaurant';

        const destDocRef = doc(colRef, docId);

        writePromises.push(
          setDoc(destDocRef, { name, tags, people })
        );
      });

      if (writePromises.length === 0) {
        alert('No restaurants selected to import.');
        return;
      }

      try {
        await Promise.all(writePromises);
        await loadGroupAndRestaurants();
        alert('Imported selected restaurants into your current group.');
      } catch (err) {
        console.error('Error importing restaurants:', err);
        alert('Something went wrong during import. Check console for details.');
      }
    }

    // --- Load group + restaurants ---

    async function loadGroupAndRestaurants() {
      if (!currentGroupId) {
        currentGroupOwnerUid = null;
        currentGroupOwnerName = null;
        restaurants = [];
        groupTags = [];
        groupPeople = [];
        setCurrentGroupDisplay();
        updateEditHint();
        renderTagOptions();
        renderPeopleOptions();
        renderFilterTagOptions();
        renderFilterPeopleOptions();
        renderList();
        return;
      }

      const gRef = groupDocRef();
      let groupExists = false;

      try {
        const gSnap = await getDoc(gRef);
        if (gSnap.exists()) {
          groupExists = true;
          const data = gSnap.data();
          currentGroupOwnerUid = data.ownerUid || null;
          currentGroupOwnerName = data.ownerName || null;
        } else {
          currentGroupOwnerUid = null;
          currentGroupOwnerName = null;
        }
      } catch (err) {
        console.error('Error loading group:', err);
        currentGroupOwnerUid = null;
        currentGroupOwnerName = null;
      }

      // If group does not exist and user is signed in, create group with them as owner
      if (!groupExists && currentUser) {
        try {
          const ownerName = currentUser.displayName || currentUser.email || 'Unknown';
          await setDoc(gRef, {
            ownerUid: currentUser.uid,
            ownerName: ownerName
          });
          currentGroupOwnerUid = currentUser.uid;
          currentGroupOwnerName = ownerName;
        } catch (err) {
          console.error('Error creating group:', err);
        }
      }

      setCurrentGroupDisplay(
        !groupExists && !currentUser
          ? 'This group does not exist yet. Sign in and select it again to create it.'
          : ''
      );

      updateEditHint();

      // Load restaurants
      restaurants = [];
      const colRef = groupRestaurantsCollection();
      if (colRef) {
        try {
          const snap = await getDocs(colRef);
          restaurants = snap.docs.map(docSnap => {
            const data = docSnap.data();
            return {
              id: docSnap.id,
              name: data.name || '',
              tags: data.tags || [],
              people: data.people || []
            };
          });
        } catch (err) {
          console.error('Error loading restaurants:', err);
        }
      }

      recomputeGroupTagsAndPeople();
      renderTagOptions();
      renderPeopleOptions();
      renderFilterTagOptions();
      renderFilterPeopleOptions();
      renderList();
    }

    async function saveRestaurantToFirestore(name, tags, people) {
      if (!hasWriteAccess()) {
        alert('You do not own this group, so you cannot add or update restaurants.');
        return;
      }

      const colRef = groupRestaurantsCollection();
      if (!colRef) {
        alert('Select a Group ID first.');
        return;
      }

      const docId = name.toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '') || 'restaurant';

      const docRef = doc(colRef, docId);

      await setDoc(docRef, {
        name,
        tags,
        people
      });

      await loadGroupAndRestaurants();
    }

    async function deleteRestaurant(id) {
      if (!hasWriteAccess()) {
        alert('You do not own this group, so you cannot delete restaurants.');
        return;
      }
      const colRef = groupRestaurantsCollection();
      if (!colRef) return;
      const docRef = doc(colRef, id);
      await deleteDoc(docRef);
      await loadGroupAndRestaurants();
    }

    // --- Auth handlers ---

    signInBtn.addEventListener('click', async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        console.error('Sign-in error:', err);
        alert('Sign-in failed: ' + (err.message || err));
      }
    });

    signOutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (err) {
        console.error('Sign-out error:', err);
      }
    });

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        authStatusEl.textContent = 'Signed in as ' + (user.displayName || user.email);
        signInBtn.disabled = true;
        signOutBtn.disabled = false;
      } else {
        authStatusEl.textContent = 'Not signed in. You can view any group, but must sign in to create or edit your own.';
        signInBtn.disabled = false;
        signOutBtn.disabled = true;
      }
      updateEditHint();
      await loadGroupAndRestaurants();
      renderImportList();
    });

    // --- Group selection ---

    document.getElementById('groupForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      const input = document.getElementById('groupInput');
      const groupIdRaw = input.value.trim();
      if (!groupIdRaw) return;

      currentGroupId = groupIdRaw
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');

      localStorage.setItem('rrp_currentGroupId', currentGroupId);

      await loadGroupAndRestaurants();
    });

    // --- Add / update restaurant form ---

    document.getElementById('addForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!currentGroupId) {
        alert('Select a Group ID first.');
        return;
      }

      const name = nameInput.value.trim();
      if (!name) return;

      const typedTags = normalizeList(tagsInput.value);
      const checkedTags = Array.from(
        document.querySelectorAll('#tagOptions input[type="checkbox"]:checked')
      ).map(cb => cb.value.toLowerCase());
      const tagSet = new Set([...typedTags, ...checkedTags]);
      const tags = Array.from(tagSet);

      const typedPeople = normalizeList(peopleInput.value);
      const checkedPeople = Array.from(
        document.querySelectorAll('#peopleOptions input[type="checkbox"]:checked')
      ).map(cb => cb.value.toLowerCase());
      const peopleSet = new Set([...typedPeople, ...checkedPeople]);
      const people = Array.from(peopleSet);

      await saveRestaurantToFirestore(name, tags, people);
    });

    // --- Import form ---

    document.getElementById('importForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      const input = document.getElementById('importGroupInput');
      const srcRaw = input.value.trim();
      if (!srcRaw) {
        importGroupId = null;
        importRestaurants = [];
        renderImportList();
        return;
      }
      await loadImportGroupRestaurants(srcRaw);
    });

    importSelectedBtn.addEventListener('click', async () => {
      await importSelectedRestaurants();
    });

    // --- Random picker ---

    document.getElementById('pickBtn').addEventListener('click', () => {
      const resultDiv = document.getElementById('result');

      if (!currentGroupId) {
        resultDiv.textContent = 'Select a Group ID first.';
        return;
      }

      const filterPeopleStr = document.getElementById('filterPeopleInput').value;
      const filterTagsStr = document.getElementById('filterTagsInput').value;

      const typedFilterPeople = normalizeList(filterPeopleStr);
      const checkedFilterPeople = Array.from(
        document.querySelectorAll('#filterPeopleOptions input[type="checkbox"]:checked')
      ).map(cb => cb.value.toLowerCase());
      const requiredPeople = Array.from(new Set([...typedFilterPeople, ...checkedFilterPeople]));

      const typedFilterTags = normalizeList(filterTagsStr);
      const checkedFilterTags = Array.from(
        document.querySelectorAll('#filterTagOptions input[type="checkbox"]:checked')
      ).map(cb => cb.value.toLowerCase());
      const requiredTags = Array.from(new Set([...typedFilterTags, ...checkedFilterTags]));

      const eligible = restaurants.filter(r => {
        const rPeople = r.people.map(p => p.toLowerCase());
        const rTags = r.tags.map(t => t.toLowerCase());

        const peopleOK =
          requiredPeople.length === 0 ||
          requiredPeople.every(p => rPeople.includes(p) || rPeople.length === 0);

        const tagsOK =
          requiredTags.length === 0 ||
          requiredTags.every(t => rTags.includes(t));

        return peopleOK && tagsOK;
      });

      if (eligible.length === 0) {
        resultDiv.textContent = 'No matching restaurants. Maybe broaden your filters?';
        return;
      }

      const i = Math.floor(Math.random() * eligible.length);
      const chosen = eligible[i];

      resultDiv.textContent = 'üéâ Tonight you\'re going to: ' + chosen.name;
    });

    // --- Init: restore last group ---

    (async function init() {
      const savedGroup = localStorage.getItem('rrp_currentGroupId');
      if (savedGroup) {
        currentGroupId = savedGroup;
        document.getElementById('groupInput').value = savedGroup;
      }
      setCurrentGroupDisplay();
      updateEditHint();
      await loadGroupAndRestaurants();
      renderImportList();
    })();
  </script>
</body>
</html>
