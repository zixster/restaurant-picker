<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Random Restaurant Picker (Firebase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1rem;
    }
    h1 {
      font-size: 1.4rem;
      text-align: center;
      margin-bottom: 0.5rem;
    }
    .section {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 1rem;
    }
    label {
      display: block;
      font-size: 0.9rem;
      margin-top: 0.4rem;
    }
    input, textarea, button {
      width: 100%;
      box-sizing: border-box;
      margin-top: 0.2rem;
      padding: 0.4rem;
      font-size: 1rem;
    }
    button {
      cursor: pointer;
    }
    .small {
      font-size: 0.8rem;
      color: #555;
    }
    .badge {
      display: inline-block;
      background: #eee;
      border-radius: 999px;
      padding: 0.1rem 0.5rem;
      margin: 0.05rem;
      font-size: 0.75rem;
    }
    .restaurant-item {
      padding: 0.3rem 0;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    .restaurant-item:last-child {
      border-bottom: none;
    }
    .restaurant-name {
      font-weight: 600;
    }
    .delete-btn {
      width: auto;
      padding: 0.2rem 0.5rem;
      font-size: 0.75rem;
    }
    #result {
      font-weight: 700;
      font-size: 1.1rem;
      text-align: center;
      margin-top: 0.5rem;
    }
    #currentGroupDisplay {
      font-size: 0.85rem;
      color: #333;
      margin-top: 0.3rem;
    }
  </style>
</head>
<body>
  <h1>Random Restaurant Picker</h1>

  <!-- Group / Family selection -->
  <div class="section">
    <h2 style="font-size:1.1rem;margin:0 0 0.5rem;">Group / Family</h2>
    <form id="groupForm">
      <label>
        Group ID (e.g. stewart-family)
        <span class="small">
          Everyone using the same Group ID shares the same restaurant list.
        </span>
        <input type="text" id="groupInput" placeholder="stewart-family" required>
      </label>
      <button type="submit" style="margin-top:0.6rem;">Use this Group</button>
    </form>
    <div id="currentGroupDisplay"></div>
  </div>

  <!-- Add restaurant -->
  <div class="section">
    <h2 style="font-size:1.1rem;margin:0 0 0.5rem;">Add / Update Restaurant</h2>
    <form id="addForm">
      <label>
        Restaurant name:
        <input type="text" id="nameInput" required>
      </label>

      <label>
        Tags (comma separated)
        <span class="small">Example: Italian, cheap, date night</span>
        <input type="text" id="tagsInput" placeholder="Italian, cheap, date night">
      </label>

      <label>
        People who are ok with this (comma separated)
        <span class="small">Example: John, Kristin, Roommate</span>
        <input type="text" id="peopleInput" placeholder="John, Kristin">
      </label>

      <button type="submit" style="margin-top:0.6rem;">Save Restaurant</button>
    </form>
  </div>

  <!-- Filters + random pick -->
  <div class="section">
    <h2 style="font-size:1.1rem;margin:0 0 0.5rem;">Pick One</h2>

    <label>
      People present (comma separated)
      <span class="small">Only show places everyone here is ok with</span>
      <input type="text" id="filterPeopleInput" placeholder="John, Kristin">
    </label>

    <label>
      Required tags (comma separated)
      <span class="small">Example: Italian, takeout</span>
      <input type="text" id="filterTagsInput" placeholder="Italian">
    </label>

    <button id="pickBtn" style="margin-top:0.6rem;">ðŸŽ² Pick Random Restaurant</button>
    <div id="result"></div>
  </div>

  <!-- List of restaurants -->
  <div class="section">
    <h2 style="font-size:1.1rem;margin:0 0 0.5rem;">Saved Restaurants for This Group</h2>
    <div id="list"></div>
    <p class="small">
      Data is stored in Firebase Firestore, per Group ID.
      Anyone with the same Group ID sees the same list.
    </p>
  </div>

  <!-- Firebase + app logic -->
  <script type="module">
    // Import Firebase from CDN (modular SDK) :contentReference[oaicite:2]{index=2}
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js';
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      getDocs,
      deleteDoc
    } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyC2xQS-opDsHikzS2DQyCZ7MNIlquENrPY",
      authDomain: "restaurant-picker-82bfa.firebaseapp.com",
      projectId: "restaurant-picker-82bfa",
      storageBucket: "restaurant-picker-82bfa.firebasestorage.app",
      messagingSenderId: "1000330063502",
      appId: "1:1000330063502:web:a307f6354e0fee2960a3df"
    };


    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentGroupId = null;
    let restaurants = []; // in-memory cache for current group

    // --- Helpers ---

    function normalizeList(str) {
      if (!str) return [];
      return str
        .split(',')
        .map(s => s.trim())
        .filter(Boolean)
        .map(s => s.toLowerCase());
    }

    function setCurrentGroupDisplay() {
      const div = document.getElementById('currentGroupDisplay');
      if (!currentGroupId) {
        div.textContent = 'No group selected yet.';
      } else {
        div.textContent = 'Current group: ' + currentGroupId;
      }
    }

    function renderList() {
      const listDiv = document.getElementById('list');
      listDiv.innerHTML = '';

      if (!currentGroupId) {
        listDiv.textContent = 'Select a Group ID above to see its restaurants.';
        return;
      }

      if (restaurants.length === 0) {
        listDiv.textContent = 'No restaurants saved yet for this group.';
        return;
      }

      restaurants.forEach((r) => {
        const item = document.createElement('div');
        item.className = 'restaurant-item';

        const left = document.createElement('div');

        const name = document.createElement('div');
        name.className = 'restaurant-name';
        name.textContent = r.name;
        left.appendChild(name);

        const tagsLine = document.createElement('div');
        r.tags.forEach(t => {
          const span = document.createElement('span');
          span.className = 'badge';
          span.textContent = t;
          tagsLine.appendChild(span);
        });
        left.appendChild(tagsLine);

        const peopleLine = document.createElement('div');
        peopleLine.className = 'small';
        peopleLine.textContent = 'OK for: ' + (r.people.join(', ') || 'Anyone');
        left.appendChild(peopleLine);

        item.appendChild(left);

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.className = 'delete-btn';
        delBtn.addEventListener('click', async () => {
          await deleteRestaurant(r.id);
        });
        item.appendChild(delBtn);

        listDiv.appendChild(item);
      });
    }

    // --- Firestore functions ---

    function groupRestaurantsCollection() {
      if (!currentGroupId) return null;
      return collection(db, 'groups', currentGroupId, 'restaurants');
    }

    async function loadRestaurantsFromFirestore() {
      if (!currentGroupId) {
        restaurants = [];
        renderList();
        return;
      }

      const colRef = groupRestaurantsCollection();
      const snap = await getDocs(colRef);

      restaurants = snap.docs.map(docSnap => {
        const data = docSnap.data();
        return {
          id: docSnap.id,
          name: data.name || '',
          tags: data.tags || [],
          people: data.people || []
        };
      });

      renderList();
    }

    async function saveRestaurantToFirestore(name, tags, people) {
      const colRef = groupRestaurantsCollection();
      if (!colRef) {
        alert('Select a Group ID first.');
        return;
      }

      // Use deterministic ID based on name (case-insensitive) to support "update by name"
      const docId = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '') || 'restaurant';

      const docRef = doc(colRef, docId);

      await setDoc(docRef, {
        name,
        tags,
        people
      });

      await loadRestaurantsFromFirestore();
    }

    async function deleteRestaurant(id) {
      const colRef = groupRestaurantsCollection();
      if (!colRef) return;
      const docRef = doc(colRef, id);
      await deleteDoc(docRef);
      await loadRestaurantsFromFirestore();
    }

    // --- Event handlers ---

    document.getElementById('groupForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      const input = document.getElementById('groupInput');
      const groupIdRaw = input.value.trim();
      if (!groupIdRaw) return;

      // Normalize: lowercase, no spaces, simple slug
      currentGroupId = groupIdRaw
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');

      // Optionally remember on this device
      localStorage.setItem('rrp_currentGroupId', currentGroupId);

      setCurrentGroupDisplay();
      await loadRestaurantsFromFirestore();
    });

    document.getElementById('addForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!currentGroupId) {
        alert('Select a Group ID first.');
        return;
      }

      const nameInput = document.getElementById('nameInput');
      const tagsInput = document.getElementById('tagsInput');
      const peopleInput = document.getElementById('peopleInput');

      const name = nameInput.value.trim();
      if (!name) return;

      const tags = normalizeList(tagsInput.value);
      const people = normalizeList(peopleInput.value);

      await saveRestaurantToFirestore(name, tags, people);

      nameInput.value = '';
    });

    document.getElementById('pickBtn').addEventListener('click', () => {
      const resultDiv = document.getElementById('result');

      if (!currentGroupId) {
        resultDiv.textContent = 'Select a Group ID first.';
        return;
      }

      const filterPeopleStr = document.getElementById('filterPeopleInput').value;
      const filterTagsStr = document.getElementById('filterTagsInput').value;

      const requiredPeople = normalizeList(filterPeopleStr);
      const requiredTags = normalizeList(filterTagsStr);

      const eligible = restaurants.filter(r => {
        const rPeople = r.people.map(p => p.toLowerCase());
        const rTags = r.tags.map(t => t.toLowerCase());

        const peopleOK =
          requiredPeople.length === 0 ||
          requiredPeople.every(p => rPeople.includes(p) || rPeople.length === 0);

        const tagsOK =
          requiredTags.length === 0 ||
          requiredTags.every(t => rTags.includes(t));

        return peopleOK && tagsOK;
      });

      if (eligible.length === 0) {
        resultDiv.textContent = 'No matching restaurants. Maybe broaden your filters?';
        return;
      }

      const i = Math.floor(Math.random() * eligible.length);
      const chosen = eligible[i];

      resultDiv.textContent = 'ðŸŽ‰ Tonight you\'re going to: ' + chosen.name;
    });

    // --- On page load: restore last group (if any) ---

    (async function init() {
      const savedGroup = localStorage.getItem('rrp_currentGroupId');
      if (savedGroup) {
        currentGroupId = savedGroup;
        document.getElementById('groupInput').value = savedGroup;
        setCurrentGroupDisplay();
        await loadRestaurantsFromFirestore();
      } else {
        setCurrentGroupDisplay();
        renderList();
      }
    })();
  </script>
</body>
</html>
