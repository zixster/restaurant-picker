<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Random Restaurant Picker (Groups + Owner + Tags + Edit)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1rem;
    }
    h1 {
      font-size: 1.4rem;
      text-align: center;
      margin-bottom: 0.5rem;
    }
    .section {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 1rem;
    }
    label {
      display: block;
      font-size: 0.9rem;
      margin-top: 0.4rem;
    }
    input, button {
      width: 100%;
      box-sizing: border-box;
      margin-top: 0.2rem;
      padding: 0.4rem;
      font-size: 1rem;
    }
    button {
      cursor: pointer;
    }
    .small {
      font-size: 0.8rem;
      color: #555;
    }
    .badge {
      display: inline-block;
      background: #eee;
      border-radius: 999px;
      padding: 0.1rem 0.5rem;
      margin: 0.05rem;
      font-size: 0.75rem;
    }
    .restaurant-item {
      padding: 0.3rem 0;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    .restaurant-item:last-child {
      border-bottom: none;
    }
    .restaurant-name {
      font-weight: 600;
    }
    .btn-row {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      align-items: flex-end;
    }
    .small-btn {
      width: auto;
      padding: 0.2rem 0.5rem;
      font-size: 0.75rem;
    }
    #result {
      font-weight: 700;
      font-size: 1.1rem;
      text-align: center;
      margin-top: 0.5rem;
    }
    #currentGroupDisplay {
      font-size: 0.85rem;
      color: #333;
      margin-top: 0.3rem;
    }
    .auth-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }
    .auth-row button {
      width: auto;
    }
    #authStatus {
      font-size: 0.85rem;
    }
    #tagOptions {
      margin-top: 0.3rem;
      padding: 0.4rem;
      border-radius: 6px;
      background: #f8f8f8;
    }
    .tag-option {
      display: inline-flex;
      align-items: center;
      margin: 0.1rem 0.4rem 0.1rem 0;
      font-size: 0.8rem;
    }
    .tag-option input {
      width: auto;
      margin-right: 0.3rem;
      margin-top: 0;
    }
  </style>
</head>
<body>
  <h1>Random Restaurant Picker</h1>

  <!-- Auth section -->
  <div class="section">
    <h2 style="font-size:1.1rem;margin:0 0 0.5rem;">Sign In</h2>
    <div class="auth-row">
      <button id="signInBtn">Sign in with Google</button>
      <button id="signOutBtn" disabled>Sign out</button>
      <span id="authStatus">Not signed in. You can view lists but must sign in to create and edit your own groups.</span>
    </div>
  </div>

  <!-- Group / List selection -->
  <div class="section">
    <h2 style="font-size:1.1rem;margin:0 0 0.5rem;">Group / List</h2>
    <form id="groupForm">
      <label>
        Group ID (e.g. My Stuff)
        <span class="small">
          Everyone using the same Group ID shares the same list.
          The first signed-in person to use a new ID becomes its owner.
        </span>
        <input type="text" id="groupInput" placeholder="my-stuff" required>
      </label>
      <button type="submit" style="margin-top:0.6rem;">Use this Group</button>
    </form>
    <div id="currentGroupDisplay"></div>
  </div>

  <!-- Add / edit restaurant -->
  <div class="section">
    <h2 style="font-size:1.1rem;margin:0 0 0.5rem;">Add / Update Restaurant</h2>
    <p class="small" id="editHint"></p>
    <form id="addForm">
      <label>
        Restaurant name:
        <input type="text" id="nameInput" required>
      </label>

      <label>
        Tags (comma separated)
        <span class="small">Example: Italian, cheap, date night</span>
        <input type="text" id="tagsInput" placeholder="Italian, cheap, date night">
      </label>

      <div id="tagOptions" class="small">
        <!-- tag checkboxes will be rendered here -->
      </div>

      <label>
        People who are ok with this (comma separated)
        <span class="small">Example: John, Bob, Roommate</span>
        <input type="text" id="peopleInput" placeholder="John, Bob, Roommate">
      </label>

      <button type="submit" style="margin-top:0.6rem;">Save Restaurant</button>
    </form>
  </div>

  <!-- Filters + random pick -->
  <div class="section">
    <h2 style="font-size:1.1rem;margin:0 0 0.5rem;">Pick One</h2>

    <label>
      People present (comma separated)
      <span class="small">Only show places everyone here is ok with</span>
      <input type="text" id="filterPeopleInput" placeholder="John, Bob, Roommate">
    </label>

    <label>
      Required tags (comma separated)
      <span class="small">Example: Italian, takeout</span>
      <input type="text" id="filterTagsInput" placeholder="Italian">
    </label>

    <button id="pickBtn" style="margin-top:0.6rem;">ðŸŽ² Pick Random Restaurant</button>
    <div id="result"></div>
  </div>

  <!-- List of restaurants -->
  <div class="section">
    <h2 style="font-size:1.1rem;margin:0 0 0.5rem;">Saved Restaurants for This Group</h2>
    <div id="list"></div>
    <p class="small">
      Data is stored in Firebase Firestore, per Group ID.
      Anyone can view any group if they know its name. Only the group owner can edit that group.
    </p>
  </div>

  <!-- Firebase + app logic -->
  <script type="module">
    // ---- Firebase imports (CDN modular SDK) ----
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js';
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      getDocs,
      deleteDoc,
      getDoc
    } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';

    // Your existing Firebase config (unchanged)
    const firebaseConfig = {
      apiKey: "AIzaSyC2xQS-opDsHikzS2DQyCZ7MNIlquENrPY",
      authDomain: "restaurant-picker-82bfa.firebaseapp.com",
      projectId: "restaurant-picker-82bfa",
      storageBucket: "restaurant-picker-82bfa.firebasestorage.app",
      messagingSenderId: "1000330063502",
      appId: "1:1000330063502:web:a307f6354e0fee2960a3df"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let currentGroupId = null;
    let currentGroupOwnerUid = null;
    let currentGroupOwnerName = null;
    let restaurants = [];
    let groupTags = [];
    let currentUser = null;

    const authStatusEl = document.getElementById('authStatus');
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const editHintEl = document.getElementById('editHint');

    const nameInput = document.getElementById('nameInput');
    const tagsInput = document.getElementById('tagsInput');
    const peopleInput = document.getElementById('peopleInput');

    function normalizeList(str) {
      if (!str) return [];
      return str
        .split(',')
        .map(s => s.trim())
        .filter(Boolean)
        .map(s => s.toLowerCase());
    }

    function hasWriteAccess() {
      return (
        currentUser &&
        currentGroupOwnerUid &&
        currentUser.uid === currentGroupOwnerUid
      );
    }

    function setCurrentGroupDisplay(extraMessage = '') {
      const div = document.getElementById('currentGroupDisplay');

      if (!currentGroupId) {
        div.textContent = 'No group selected yet.';
        return;
      }

      let text = `Current group: ${currentGroupId}`;
      if (currentGroupOwnerUid) {
        if (currentUser && currentUser.uid === currentGroupOwnerUid) {
          text += ' (You own this group)';
        } else if (currentGroupOwnerName) {
          text += ` (Owner: ${currentGroupOwnerName})`;
        } else {
          text += ' (Owner unknown)';
        }
      } else {
        text += ' (This group does not exist yet.)';
      }

      if (extraMessage) {
        text += ' â€” ' + extraMessage;
      }

      div.textContent = text;
    }

    function updateEditHint() {
      if (!currentGroupId) {
        editHintEl.textContent = 'Select or create a group to view and edit restaurants.';
        return;
      }

      if (!currentGroupOwnerUid) {
        if (!currentUser) {
          editHintEl.textContent = 'This group does not exist yet. Sign in and press "Use this Group" again to create it and become the owner.';
        } else {
          editHintEl.textContent = 'Creating this group for you as owner...';
        }
        return;
      }

      if (hasWriteAccess()) {
        editHintEl.textContent = 'You own this group. You can add, edit, and delete restaurants. Use âœï¸ Edit to modify an existing one.';
      } else {
        editHintEl.textContent = 'This group is read-only for you. You can view and pick, but only the owner can edit.';
      }
    }

    function recomputeGroupTags() {
      const set = new Set();
      restaurants.forEach(r => {
        (r.tags || []).forEach(t => {
          if (t) set.add(t);
        });
      });
      groupTags = Array.from(set).sort();
    }

    function setTagCheckboxesForTags(tags) {
      const lowerSet = new Set((tags || []).map(t => t.toLowerCase()));
      document
        .querySelectorAll('#tagOptions input[type="checkbox"]')
        .forEach(cb => {
          cb.checked = lowerSet.has(cb.value.toLowerCase());
        });
    }

    function renderTagOptions() {
      const container = document.getElementById('tagOptions');
      container.innerHTML = '';

      if (!currentGroupId) {
        container.textContent = 'Select a group to see its tags.';
        return;
      }

      if (groupTags.length === 0) {
        container.textContent = 'No tags in this group yet. Type new tags above to start building a list.';
        return;
      }

      const info = document.createElement('div');
      info.textContent = 'Existing tags in this group (tap to add to this restaurant):';
      container.appendChild(info);

      groupTags.forEach(tag => {
        const label = document.createElement('label');
        label.className = 'tag-option';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = tag;

        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(tag));
        container.appendChild(label);
      });
    }

    function renderList() {
      const listDiv = document.getElementById('list');
      listDiv.innerHTML = '';

      if (!currentGroupId) {
        listDiv.textContent = 'Select a Group ID above to see its restaurants.';
        return;
      }

      if (restaurants.length === 0) {
        listDiv.textContent = 'No restaurants saved yet for this group.';
        return;
      }

      restaurants.forEach((r) => {
        const item = document.createElement('div');
        item.className = 'restaurant-item';

        const left = document.createElement('div');

        const nameEl = document.createElement('div');
        nameEl.className = 'restaurant-name';
        nameEl.textContent = r.name;
        left.appendChild(nameEl);

        const tagsLine = document.createElement('div');
        r.tags.forEach(t => {
          const span = document.createElement('span');
          span.className = 'badge';
          span.textContent = t;
          tagsLine.appendChild(span);
        });
        left.appendChild(tagsLine);

        const peopleLine = document.createElement('div');
        peopleLine.className = 'small';
        peopleLine.textContent = 'OK for: ' + (r.people.join(', ') || 'Anyone');
        left.appendChild(peopleLine);

        item.appendChild(left);

        const btnCol = document.createElement('div');
        btnCol.className = 'btn-row';

        const editBtn = document.createElement('button');
        editBtn.textContent = 'âœï¸ Edit';
        editBtn.className = 'small-btn';
        editBtn.disabled = !hasWriteAccess();
        editBtn.title = hasWriteAccess()
          ? 'Edit this restaurant'
          : 'Only the group owner can edit restaurants';

        editBtn.addEventListener('click', () => {
          if (!hasWriteAccess()) {
            alert('You do not own this group, so you cannot edit restaurants.');
            return;
          }
          nameInput.value = r.name;
          tagsInput.value = (r.tags || []).join(', ');
          peopleInput.value = (r.people || []).join(', ');
          setTagCheckboxesForTags(r.tags);
          document.getElementById('addForm').scrollIntoView({ behavior: 'smooth' });
        });

        btnCol.appendChild(editBtn);

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.className = 'small-btn';
        delBtn.disabled = !hasWriteAccess();
        delBtn.title = hasWriteAccess()
          ? 'Delete this restaurant'
          : 'Only the group owner can delete restaurants';

        delBtn.addEventListener('click', async () => {
          if (!hasWriteAccess()) {
            alert('You do not own this group, so you cannot delete restaurants.');
            return;
          }
          await deleteRestaurant(r.id);
        });

        btnCol.appendChild(delBtn);

        item.appendChild(btnCol);

        listDiv.appendChild(item);
      });
    }

    function groupDocRef() {
      if (!currentGroupId) return null;
      return doc(db, 'groups', currentGroupId);
    }

    function groupRestaurantsCollection() {
      if (!currentGroupId) return null;
      return collection(db, 'groups', currentGroupId, 'restaurants');
    }

    async function loadGroupAndRestaurants() {
      if (!currentGroupId) {
        currentGroupOwnerUid = null;
        currentGroupOwnerName = null;
        restaurants = [];
        groupTags = [];
        setCurrentGroupDisplay();
        updateEditHint();
        renderTagOptions();
        renderList();
        return;
      }

      const gRef = groupDocRef();
      let groupExists = false;

      try {
        const gSnap = await getDoc(gRef);
        if (gSnap.exists()) {
          groupExists = true;
          const data = gSnap.data();
          currentGroupOwnerUid = data.ownerUid || null;
          currentGroupOwnerName = data.ownerName || null;
        } else {
          currentGroupOwnerUid = null;
          currentGroupOwnerName = null;
        }
      } catch (err) {
        console.error('Error loading group:', err);
        currentGroupOwnerUid = null;
        currentGroupOwnerName = null;
      }

      // If group does not exist and user is signed in, create group with them as owner
      if (!groupExists && currentUser) {
        try {
          const ownerName = currentUser.displayName || currentUser.email || 'Unknown';
          await setDoc(gRef, {
            ownerUid: currentUser.uid,
            ownerName: ownerName
          });
          currentGroupOwnerUid = currentUser.uid;
          currentGroupOwnerName = ownerName;
        } catch (err) {
          console.error('Error creating group:', err);
        }
      }

      setCurrentGroupDisplay(
        !groupExists && !currentUser
          ? 'This group does not exist yet. Sign in and select it again to create it.'
          : ''
      );

      updateEditHint();

      // Load restaurants
      restaurants = [];
      const colRef = groupRestaurantsCollection();
      if (colRef) {
        try {
          const snap = await getDocs(colRef);
          restaurants = snap.docs.map(docSnap => {
            const data = docSnap.data();
            return {
              id: docSnap.id,
              name: data.name || '',
              tags: data.tags || [],
              people: data.people || []
            };
          });
        } catch (err) {
          console.error('Error loading restaurants:', err);
        }
      }

      recomputeGroupTags();
      renderTagOptions();
      renderList();
    }

    async function saveRestaurantToFirestore(name, tags, people) {
      if (!hasWriteAccess()) {
        alert('You do not own this group, so you cannot add or update restaurants.');
        return;
      }

      const colRef = groupRestaurantsCollection();
      if (!colRef) {
        alert('Select a Group ID first.');
        return;
      }

      const docId = name.toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '') || 'restaurant';

      const docRef = doc(colRef, docId);

      await setDoc(docRef, {
        name,
        tags,
        people
      });

      await loadGroupAndRestaurants();
    }

    async function deleteRestaurant(id) {
      if (!hasWriteAccess()) {
        alert('You do not own this group, so you cannot delete restaurants.');
        return;
      }
      const colRef = groupRestaurantsCollection();
      if (!colRef) return;
      const docRef = doc(colRef, id);
      await deleteDoc(docRef);
      await loadGroupAndRestaurants();
    }

    // --- Auth handlers ---

    signInBtn.addEventListener('click', async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        console.error('Sign-in error:', err);
        alert('Sign-in failed: ' + (err.message || err));
      }
    });

    signOutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (err) {
        console.error('Sign-out error:', err);
      }
    });

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        authStatusEl.textContent = 'Signed in as ' + (user.displayName || user.email);
        signInBtn.disabled = true;
        signOutBtn.disabled = false;
      } else {
        authStatusEl.textContent = 'Not signed in. You can view any group, but must sign in to create or edit your own.';
        signInBtn.disabled = false;
        signOutBtn.disabled = true;
      }
      updateEditHint();
      await loadGroupAndRestaurants();
    });

    // --- Group selection ---

    document.getElementById('groupForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      const input = document.getElementById('groupInput');
      const groupIdRaw = input.value.trim();
      if (!groupIdRaw) return;

      currentGroupId = groupIdRaw
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');

      localStorage.setItem('rrp_currentGroupId', currentGroupId);

      await loadGroupAndRestaurants();
    });

    // --- Add / update restaurant form ---

    document.getElementById('addForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!currentGroupId) {
        alert('Select a Group ID first.');
        return;
      }

      const name = nameInput.value.trim();
      if (!name) return;

      const typedTags = normalizeList(tagsInput.value);

      const checkedTags = Array.from(
        document.querySelectorAll('#tagOptions input[type="checkbox"]:checked')
      ).map(cb => cb.value.toLowerCase());

      const tagSet = new Set([...typedTags, ...checkedTags]);
      const tags = Array.from(tagSet);

      const people = normalizeList(peopleInput.value);

      await saveRestaurantToFirestore(name, tags, people);
    });

    // --- Random picker ---

    document.getElementById('pickBtn').addEventListener('click', () => {
      const resultDiv = document.getElementById('result');

      if (!currentGroupId) {
        resultDiv.textContent = 'Select a Group ID first.';
        return;
      }

      const filterPeopleStr = document.getElementById('filterPeopleInput').value;
      const filterTagsStr = document.getElementById('filterTagsInput').value;

      const requiredPeople = normalizeList(filterPeopleStr);
      const requiredTags = normalizeList(filterTagsStr);

      const eligible = restaurants.filter(r => {
        const rPeople = r.people.map(p => p.toLowerCase());
        const rTags = r.tags.map(t => t.toLowerCase());

        const peopleOK =
          requiredPeople.length === 0 ||
          requiredPeople.every(p => rPeople.includes(p) || rPeople.length === 0);

        const tagsOK =
          requiredTags.length === 0 ||
          requiredTags.every(t => rTags.includes(t));

        return peopleOK && tagsOK;
      });

      if (eligible.length === 0) {
        resultDiv.textContent = 'No matching restaurants. Maybe broaden your filters?';
        return;
      }

      const i = Math.floor(Math.random() * eligible.length);
      const chosen = eligible[i];

      resultDiv.textContent = 'ðŸŽ‰ Tonight you\'re going to: ' + chosen.name;
    });

    // --- Init: restore last group ---

    (async function init() {
      const savedGroup = localStorage.getItem('rrp_currentGroupId');
      if (savedGroup) {
        currentGroupId = savedGroup;
        document.getElementById('groupInput').value = savedGroup;
      }
      setCurrentGroupDisplay();
      updateEditHint();
      await loadGroupAndRestaurants();
    })();
  </script>
</body>
</html>
